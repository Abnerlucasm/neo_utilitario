<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#00d1b2">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
    <title>Gerenciamento Glassfish</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="dark-theme.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="/componentes/navbar-component.js"></script>
    <style>
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            position: absolute;
            top: 10px;
            right: 10px;
        }
        .status-active {
            background-color: green;
        }
        .status-inactive {
            background-color: red;
        }
        .card-icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
            color: #00d1b2;
        }
        .add-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #00d1b2;
            color: white;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            font-size: 1.5rem;
        }
        .empty-message {
            text-align: center;
            margin-top: 50px;
            font-size: 1.2rem;
            color: #666;
        }
        .control-buttons {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .card-actions button {
            margin-right: 8px;
        }
        .input-number {
            display: flex;
            align-items: center;
        }
        .input-number button {
            border: none;
            background-color: #f5f5f5;
            padding: 0 10px;
            cursor: pointer;
        }
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 1rem;
            border-radius: 4px;
            z-index: 1000;
            display: none;
            max-width: 300px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.16);
        }
        .toast.is-success {
            background-color: #48c774;
            color: white;
        }
        .toast.is-danger {
            background-color: #f14668;
            color: white;
        }
        .toast.show {
            display: block;
            animation: fadeIn 0.5s, fadeOut 0.5s 2.5s;
        }
        @keyframes fadeIn {
            from {opacity: 0;}
            to {opacity: 1;}
        }
        @keyframes fadeOut {
            from {opacity: 1;}
            to {opacity: 0;}
        }
        .hero {
            background: linear-gradient(135deg, #00d1b2 0%, #1a1a1a 100%);
            margin-bottom: 2rem;
            padding: 2rem 0;
        }
        .dashboard-stats {
            margin-bottom: 2rem;
        }
        .stat-box {
            background: white;
            padding: 1.5rem;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-box .icon {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: #00d1b2;
        }
        .system-info {
            margin-bottom: 2rem;
            font-family: 'Courier New', monospace;
        }
        .system-info pre {
            background: #2d2d2d;
            color: #00d1b2;
            padding: 1rem;
            border-radius: 4px;
        }
        .filter-section {
            background: white;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .server-grid {
            margin-top: 2rem;
        }
        .technical-info {
            font-size: 0.9rem;
            color: #666;
        }
        .stat-box .progress {
            margin-top: 0.5rem;
            height: 0.5rem;
        }
        .stat-box .progress.is-danger {
            background-color: #ff3860;
        }
        .stat-box .progress.is-warning {
            background-color: #ffdd57;
        }
        .stat-box .progress.is-success {
            background-color: #23d160;
        }
        .category-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
            color: white;
            z-index: 1;
        }
        .category-badge.is-warning {
            background-color: #81a92c;
            color: rgb(255, 255, 255);
        }
        .category-badge.is-info {
            background-color: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2px 6px;
        }
        .category-badge img {
            height: 20px;
            width: auto;
        }
        .tab-content {
            display: none;
        }
        .tab-content.is-active {
            display: block;
        }
        .loading-icon {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
        }
        .loading-icon.is-hidden {
            display: none;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .fa-spin {
            animation: spin 1s linear infinite;
        }
        .loading-container {
            padding: 2rem;
            color: #666;
        }
        .loading-container .icon {
            margin-bottom: 1rem;
        }
        .applications-container {
            min-height: 200px;
            position: relative;
        }
        .status-indicator.is-success {
            background-color: #23d160;
        }
        .status-indicator.is-danger {
            background-color: #ff3860;
        }
        .status-indicator.is-warning {
            background-color: #ffdd57;
        }
        .server-details-container {
            margin-top: 2rem;
        }
        .server-detail {
            margin-bottom: 0.5rem;
        }
        .server-detail .tag {
            margin-left: 0.5rem;
        }
        .card {
            position: relative;
            border-radius: 15px;
        }
        .card.is-warning {
            background-color: #fff3cd;
        }
        .card-actions {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.5rem;
        }
        .user-buttons {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        .log-container {
            background: white;
            padding: 1.5rem;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-top: 2rem;
            margin-left: 1rem;
            margin-right: 1rem;
        }
        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .log-controls {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        .log-viewer {
            background-color: #1e1e1e;
            color: #d4d4d4;
            border-top: 1px solid #333;
            padding: 1rem;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9rem;
            display: none; /* Inicialmente oculto */
        }
        .log-entry {
            margin-bottom: 0.5rem;
        }
        .log-entry.info {
            color: #9cdcfe; /* Azul claro para info */
        }
        .log-entry.error {
            color: #f44747; /* Vermelho para error */
        }
        .log-entry.warning {
            color: #ffdd57; /* Amarelo para warning */
        }
        .add-button-container {
            display: flex;
            justify-content: center;
            margin-top: 1rem;
        }
        .system-info-container {
            background: white;
            padding: 1.5rem;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-top: 2rem;
            margin-left: 1rem;
            margin-right: 1rem;
        }
        .system-info {
            font-size: 1rem;
            color: #333;
        }
        #copy-log-button {
            margin-top: 10px;
        }
    </style>
</head>
<body class="has-background-light">
    <!-- Navbar -->
    <neo-navbar></neo-navbar>

    <!-- Hero Section -->
    <section class="hero">
        <div class="hero-body">
            <div class="container">
                <h1 class="title has-text-white has-text-centered">
                    Gerenciamento de Servidores Glassfish
                </h1>
                <p class="subtitle has-text-white has-text-centered">
                    Monitoramento e Controle de Instâncias
                </p>
            </div>
        </div>
    </section>

    <section class="section">
        <div class="container">
            <!-- Dashboard Stats -->
            <div class="columns stats-container">
                <div class="column">
                    <div class="stat-box">
                        <span class="icon">
                            <i class="fas fa-server"></i>
                        </span>
                        <p class="heading">Total de Servidores</p>
                        <p class="title" id="total-servers">0</p>
                    </div>
                </div>
                <div class="column">
                    <div class="stat-box">
                        <span class="icon">
                            <i class="fas fa-server"></i>
                        </span>
                        <p class="heading">Servidores Ativos</p>
                        <p class="title" id="active-servers">0</p>
                    </div>
                </div>
                <div class="column">
                    <div class="stat-box">
                        <span class="icon">
                            <i class="fas fa-memory"></i>
                        </span>
                        <p class="heading">RAM Média</p>
                        <p class="title" id="avg-ram-usage">0%</p>
                        <progress class="progress is-info" id="ram-progress" value="0" max="100"></progress>
                    </div>
                </div>
                <div class="column">
                    <div class="stat-box">
                        <span class="icon">
                            <i class="fas fa-microchip"></i>
                        </span>
                        <p class="heading">CPU Média</p>
                        <p class="title" id="avg-cpu-usage">0%</p>
                        <progress class="progress is-info" id="cpu-progress" value="0" max="100"></progress>
                    </div>
                </div>
            </div>

            <!-- Adicionar container para detalhes dos servidores -->
            <div id="server-details" class="server-details-container">
                <!-- Detalhes dos servidores serão inseridos aqui -->
            </div>

            <!-- Filtros e Controles -->
            <div class="filter-section">
                <div class="columns is-vcentered">
                    <div class="column">
                        <div class="select">
                            <select id="filter-status" onchange="filterCards()">
                                <option value="all">Todos os Status</option>
                                <option value="active">Ativos</option>
                                <option value="inactive">Inativos</option>
                            </select>
                        </div>
                    </div>
                    <div class="column">
                        <div class="buttons">
                            <button class="button is-info is-small" onclick="sortCards('name')">
                                <span class="icon">
                                    <i class="fas fa-sort-alpha-down"></i>
                                </span>
                                <span>Nome</span>
                            </button>
                            <button class="button is-info is-small" onclick="sortCards('status')">
                                <span class="icon">
                                    <i class="fas fa-sort"></i>
                                </span>
                                <span>Status</span>
                            </button>
                            <button class="button is-info is-small" onclick="sortCards('setor')">
                                <span class="icon">
                                    <i class="fas fa-building"></i>
                                </span>
                                <span>Setor</span>
                            </button>
                        </div>
                    </div>
                    <div class="column">
                        <p id="results-count" class="has-text-right has-text-weight-semibold"></p>
                    </div>
                </div>
            </div>

            <!-- Mensagem inicial -->
            <div id="empty-message" class="empty-message">
                <div class="notification is-info is-light">
                    <p class="has-text-centered">
                        <span class="icon">
                            <i class="fas fa-info-circle"></i>
                        </span>
                        Nenhum serviço Glassfish cadastrado. Clique no botão "+" para adicionar.
                    </p>
                </div>
            </div>

            <!-- Grid de Cards -->
            <div class="columns is-multiline server-grid" id="cards-container"></div>
        </div>

        <!-- Botão para adicionar -->
        <div class="add-button-container">
            <button class="button is-primary" onclick="openAddModal()">
                <span class="icon"><i class="fas fa-plus"></i></span>
                <span>Adicionar Serviço</span>
            </button>
        </div>
    </section>

    <!-- Modal para Adicionar/Editar Glassfish -->
    <div class="modal" id="add-modal">
        <div class="modal-background" onclick="closeAddModal()"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title" id="modal-title">Adicionar Glassfish</p>
                <button class="delete" aria-label="close" onclick="closeAddModal()"></button>
            </header>
            <section class="modal-card-body">
                <div class="field">
                    <label class="label">Nome do Serviço</label>
                    <div class="control">
                        <input class="input" type="text" id="service-name" placeholder="Nome do serviço">
                    </div>
                </div>
                <div class="field">
                    <label class="label">IP</label>
                    <div class="control">
                        <input class="input" type="text" id="service-ip" required>
                    </div>
                </div>
                <div class="field">
                    <label class="label">Porta Admin</label>
                    <div class="control input-number">
                        <button onclick="adjustPort('decrease')">-</button>
                        <input class="input" type="number" id="service-port" value="4848">
                        <button onclick="adjustPort('increase')">+</button>
                    </div>
                </div>
                <div class="field">
                    <label class="label">Porta Produção</label>
                    <div class="control">
                        <input class="input" type="number" id="production-port" placeholder="Porta de Produção" value="8091">
                    </div>
                </div>
                <div class="field">
                    <label class="label">Domínio</label>
                    <div class="control">
                        <input class="input" type="text" id="service-domain" placeholder="Domínio do serviço">
                    </div>
                </div>
                <div class="field">
                    <label class="label">Setor</label>
                    <div class="control">
                        <div class="select is-fullwidth">
                            <select id="service-category">
                                <option value="Setor Sup. Externo">Setor Sup. Externo</option>
                                <option value="Setor Sup. Interno">Setor Sup. Interno</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="field">
                    <label class="label">Senha</label>
                    <div class="control">
                        <div class="input-group">
                            <input class="input" type="password" id="service-password" placeholder="Senha do serviço">
                            <button type="button" onclick="togglePasswordVisibility()"><i class="fas fa-eye" id="eye-icon"></i></button>
                        </div>
                    </div>
                </div>
                <div class="field">
                    <label class="label">Usuário SSH</label>
                    <div class="control">
                        <input class="input" type="text" id="service-ssh-username" required>
                    </div>
                </div>
                <div class="field">
                    <label class="label">Senha SSH</label>
                    <div class="control">
                        <input class="input" type="password" id="service-ssh-password" required>
                    </div>
                </div>
                <div class="field">
                    <button class="button is-info" type="button" onclick="testSSHConnection()">
                        Testar Conexão SSH
                    </button>
                    <p id="ssh-test-result" class="help"></p>
                </div>
                <div class="field">
                    <label class="label">Caminho de Instalação</label>
                    <div class="control">
                        <input class="input" type="text" id="service-install-path" 
                            placeholder="/glassfish6.2.5" 
                            value="/glassfish6.2.5">
                    </div>
                </div>
                <div class="field">
                    <label class="label">Tipo de Acesso</label>
                    <div class="control">
                        <div class="select is-fullwidth">
                            <select id="service-access-type" onchange="handleAccessTypeChange()">
                                <option value="local">Rede Local</option>
                                <option value="external">Acesso Externo</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="field">
                    <button class="button is-link" onclick="openAdminPanel()">
                        <span class="icon">
                            <i class="fas fa-external-link-alt"></i>
                        </span>
                        <span>Acessar Painel Admin</span>
                    </button>
                </div>
                <div class="field">
                    <button class="button is-link" onclick="accessNeoWeb()">
                        <span class="icon">
                            <i class="fas fa-external-link-alt"></i>
                        </span>
                        <span>Acessar NeoWeb</span>
                    </button>
                </div>
            </section>
            <footer class="modal-card-foot">
                <button class="button is-success" onclick="saveGlassfish()">
                    <span class="icon">
                        <i class="fas fa-save"></i>
                    </span>
                    <span>Salvar</span>
                </button>
                <button class="button" onclick="closeAddModal()">
                    <span class="icon">
                        <i class="fas fa-times"></i>
                    </span>
                    <span>Cancelar</span>
                </button>
            </footer>
        </div>
    </div>

    <!-- Modal para exibir logs -->
    <div class="modal" id="logs-modal">
        <div class="modal-background" onclick="closeLogsModal()"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title">Logs do Serviço</p>
                <div class="buttons">
                    <button class="button is-small" onclick="toggleLiveLog()">
                        <span id="live-log-status">Iniciar Live Log</span>
                    </button>
                    <button class="delete" aria-label="close" onclick="closeLogsModal()"></button>
                </div>
            </header>
            <section class="modal-card-body">
                <pre id="logs-content">Carregando logs...</pre>
                <button id="copy-log-button" class="button is-info mt-3">Copiar Logs</button>
            </section>
            <footer class="modal-card-foot">
                <button class="button" onclick="closeLogsModal()">Fechar</button>
            </footer>
        </div>
    </div>

    <!-- Modal de Manutenção -->
    <div class="modal" id="maintenance-modal">
        <div class="modal-background" onclick="closeMaintenanceModal()"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title">Manutenção do Serviço</p>
                <button class="delete" aria-label="close" onclick="closeMaintenanceModal()"></button>
            </header>
            <section class="modal-card-body">
                <div class="content">
                    <p class="has-text-warning">
                        <span class="icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </span>
                        <strong>Atenção:</strong> Esta operação pode excluir dados importantes.
                    </p>
                    
                    <div class="field">
                        <label class="checkbox">
                            <input type="checkbox" id="clean-applications">
                            Apagar Applications
                            <p class="help">Remove todos os arquivos da pasta applications</p>
                        </label>
                    </div>
                    
                    <div class="field">
                        <label class="checkbox">
                            <input type="checkbox" id="clean-logs">
                            Apagar Logs
                            <p class="help">Remove todos os arquivos de log do serviço</p>
                        </label>
                    </div>
                    
                    <div class="field">
                        <label class="checkbox">
                            <input type="checkbox" id="clean-generated">
                            Apagar Generated
                            <p class="help">Remove todos os arquivos gerados temporariamente</p>
                        </label>
                    </div>
                    
                    <div class="field">
                        <label class="checkbox">
                            <input type="checkbox" id="clean-autodeploy">
                            Apagar Autodeploy
                            <p class="help">Remove todos os arquivos da pasta autodeploy</p>
                        </label>
                    </div>
                    
                    <div class="notification is-info is-light mt-4">
                        <p>
                            <strong>Dica:</strong> É recomendado parar o serviço antes de realizar a limpeza.
                        </p>
                    </div>
                </div>
            </section>
            <footer class="modal-card-foot">
                <button class="button is-danger" onclick="executeMaintenanceFromModal(this)">
                    <span class="icon">
                        <i class="fas fa-broom"></i>
                    </span>
                    <span>Executar Limpeza</span>
                </button>
                <button class="button" onclick="closeMaintenanceModal()">
                    <span class="icon">
                        <i class="fas fa-times"></i>
                    </span>
                    <span>Cancelar</span>
                </button>
            </footer>
        </div>
    </div>

    <!-- Modal de Configuração do Domain -->
    <div class="modal" id="domain-config-modal">
        <div class="modal-background" onclick="closeDomainConfigModal()"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title">Configurações do Domain</p>
                <button class="delete" aria-label="close" onclick="closeDomainConfigModal()"></button>
            </header>
            <section class="modal-card-body">
                <!-- Tabs -->
                <div class="tabs">
                    <ul>
                        <li class="is-active">
                            <a onclick="switchTab('database')">
                                <span class="icon is-small"><i class="fas fa-database"></i></span>
                                <span>Banco de Dados</span>
                            </a>
                        </li>
                        <li>
                            <a onclick="switchTab('applications')">
                                <span class="icon is-small"><i class="fas fa-cube"></i></span>
                                <span>Aplicações</span>
                                <span class="tag is-warning is-light ml-2">Beta</span>
                            </a>
                        </li>
                    </ul>
                </div>
                
                <!-- Conteúdo das Tabs -->
                <div id="database-tab" class="tab-content" style="display: block;">
                    <h3 class="title is-5">Configuração do Banco de Dados</h3>
                    <div class="field">
                        <label class="label">Servidor do Banco</label>
                        <div class="control">
                            <input class="input" type="text" id="db-server" placeholder="Ex: localhost">
                        </div>
                    </div>
                    
                    <div class="field">
                        <label class="label">Usuário</label>
                        <div class="control">
                            <input class="input" type="text" id="db-user" placeholder="Ex: postgres">
                        </div>
                    </div>
                    
                    <div class="field">
                        <label class="label">Senha</label>
                        <div class="control">
                            <input class="input" type="password" id="db-password">
                        </div>
                    </div>
                    
                    <div class="field">
                        <label class="label">Nome do Banco</label>
                        <div class="control">
                            <input class="input" type="text" id="db-name" placeholder="Ex: neocorp">
                        </div>
                    </div>
                </div>
                
                <div id="applications-tab" class="tab-content" style="display: none;">
                    <h3 class="title is-5">Aplicações Instaladas</h3>
                    <div class="field">
                        <div class="file has-name is-fullwidth">
                            <label class="file-label">
                                <input class="file-input" type="file" id="application-file" 
                                    accept=".war,.ear,.jar">
                                <span class="file-cta">
                                    <span class="file-icon">
                                        <i class="fas fa-upload"></i>
                                    </span>
                                    <span class="file-label">
                                        Escolher arquivo...
                                    </span>
                                </span>
                                <span class="file-name" id="file-name">
                                    Nenhum arquivo selecionado
                                </span>
                            </label>
                        </div>
                        <button class="button is-info mt-2 is-fullwidth" onclick="uploadApplication()" 
                            id="upload-button" disabled>
                            <span class="icon">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </span>
                            <span>Fazer Upload</span>
                        </button>
                    </div>
                    <div class="notification is-info is-light mb-4">
                        <p>
                            <span class="icon"><i class="fas fa-info-circle"></i></span>
                            Arquivos suportados: .war, .ear, .jar
                        </p>
                    </div>
                    <div id="applications-list" class="applications-container">
                        <div class="loading-container has-text-centered" id="applications-loading">
                            <span class="icon is-large">
                                <i class="fas fa-spinner fa-spin fa-2x"></i>
                            </span>
                            <p class="help">Carregando aplicações...</p>
                        </div>
                        <div id="applications-content" class="is-hidden">
                            <!-- Lista de aplicações será carregada aqui -->
                        </div>
                    </div>
                </div>
            </section>
            <footer class="modal-card-foot">
                <button class="button is-success" onclick="saveDomainConfig()">
                    <span class="icon">
                        <i class="fas fa-save"></i>
                    </span>
                    <span>Salvar</span>
                </button>
                <button class="button" onclick="closeDomainConfigModal()">
                    <span class="icon">
                        <i class="fas fa-times"></i>
                    </span>
                    <span>Cancelar</span>
                </button>
            </footer>
        </div>
    </div>

    <!-- Modal para selecionar o nome do usuário -->
    <div class="modal" id="user-name-modal">
        <div class="modal-background" onclick="closeUserNameModal()"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title">Selecione seu Nome</p>
                <button class="delete" aria-label="close" onclick="closeUserNameModal()"></button>
            </header>
            <section class="modal-card-body">
                <div class="field">
                    <label class="label">Nome do Usuário</label>
                    <div class="control has-icons-left">
                        <input class="input" type="text" id="modal-user-name" placeholder="Digite seu nome">
                        <span class="icon is-left">
                            <i class="fas fa-user"></i>
                        </span>
                    </div>
                </div>
            </section>
            <footer class="modal-card-foot">
                <button class="button is-success" onclick="confirmUserName()">
                    <span class="icon"><i class="fas fa-check"></i></span>
                    <span>Confirmar</span>
                </button>
                <button class="button" onclick="closeUserNameModal()">
                    <span class="icon"><i class="fas fa-times"></i></span>
                    <span>Cancelar</span>
                </button>
            </footer>
        </div>
    </div>

    <!-- <div id="toast" class="toast"></div> -->

    <div class="log-container">
        <div class="log-header">
            <h2 class="title is-5">Visualizador de Log</h2>
        </div>
        <div id="log-viewer" class="log-viewer">
            <!-- As mensagens de log serão inseridas aqui -->
        </div>
        <div class="log-controls">
            <button class="button is-small" onclick="toggleLogViewer()">Ativar/Desativar Log</button>
            <button class="button is-small" onclick="clearLogViewer()">Limpar Log</button>
        </div>
    </div>

    <script>
        // Registrar o Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('ServiceWorker registrado com sucesso:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('Falha ao registrar o ServiceWorker:', error);
                    });
            });
        }

        const cardsContainer = document.getElementById('cards-container');
        const emptyMessage = document.getElementById('empty-message');
        const resultsCount = document.getElementById('results-count');
        const modalTitle = document.getElementById('modal-title');
        let editingIndex = null;
        let services = [];
        let currentWebSocket = null;
        let currentServiceId = null;
        let statusCheckInterval = null;
        let currentMaintenanceIndex = null;
        let currentDomainConfigIndex = null;
        let logViewerActive = false;

        // Função para obter os dados do MongoDB
        async function fetchServices() {
            try {
                const response = await fetch('/api/servicos');
                if (!response.ok) {
                    throw new Error('Erro ao obter serviços');
                }
                services = await response.json();
                renderCards(services);
                await checkAllServicesStatus(); // Verificar status inicial
            } catch (error) {
                console.error('Erro ao carregar serviços:', error);
                showToast('Erro ao carregar serviços. Por favor, recarregue a página.', 'danger');
            }
        }

        // Função para verificar o status de todos os serviços
        async function checkAllServicesStatus() {
            for (let service of services) {
                try {
                    await checkServiceStatus(service);
                } catch (error) {
                    console.error(`Erro ao verificar status do serviço ${service.name}:`, error);
                }
            }
        }

        function openAddModal(editIndex = null) {
            editingIndex = editIndex;
            if (editIndex !== null) {
                const service = services[editIndex];
                document.getElementById('service-name').value = service.name;
                document.getElementById('service-ip').value = service.ip;
                document.getElementById('service-port').value = service.port;
                document.getElementById('service-domain').value = service.domain;
                document.getElementById('service-ssh-username').value = service.sshUsername;
                document.getElementById('service-ssh-password').value = service.sshPassword;
                document.getElementById('service-install-path').value = service.installPath;
                document.getElementById('service-category').value = service.setor || 'Cliente';
                document.getElementById('service-access-type').value = service.accessType || 'local';
                document.getElementById('production-port').value = service.productionPort || '8081';
                modalTitle.textContent = 'Editar Glassfish';
            } else {
                document.getElementById('service-name').value = '';
                document.getElementById('service-ip').value = '';
                document.getElementById('service-port').value = 8080;
                document.getElementById('service-domain').value = '';
                document.getElementById('service-ssh-username').value = '';
                document.getElementById('service-ssh-password').value = '';
                document.getElementById('service-install-path').value = '/glassfish6.2.5';
                document.getElementById('service-category').value = 'Cliente';
                document.getElementById('service-access-type').value = 'local';
                document.getElementById('production-port').value = '8081';
                modalTitle.textContent = 'Adicionar Glassfish';
            }
            document.getElementById('add-modal').classList.add('is-active');
        }

        function closeAddModal() {
            document.getElementById('add-modal').classList.remove('is-active');
            editingIndex = null;
        }

        // Função para salvar ou editar serviço no MongoDB
        async function saveGlassfish() {
                const service = {
                    name: document.getElementById('service-name').value,
                    ip: document.getElementById('service-ip').value,
                    port: parseInt(document.getElementById('service-port').value),
                    domain: document.getElementById('service-domain').value,
                    password: document.getElementById('service-password').value || 'admin',
                    sshUsername: document.getElementById('service-ssh-username').value,
                    sshPassword: document.getElementById('service-ssh-password').value,
                    installPath: document.getElementById('service-install-path').value || '/srv/glassfish6.2.5',
                    productionPort: parseInt(document.getElementById('production-port').value),
                    setor: document.getElementById('service-category').value,
                    accessType: document.getElementById('service-access-type').value
                };

                if (!service.name || !service.ip || !service.domain || !service.sshUsername || !service.sshPassword) {
                    showToast('Por favor, preencha todos os campos obrigatórios', 'danger');
                    return;
                }

                const url = editingIndex !== null ? 
                    `/api/servicos/${services[editingIndex]._id}` : 
                    '/api/servicos';

                const method = editingIndex !== null ? 'PUT' : 'POST';

                console.log('Enviando dados do serviço:', { ...service, sshPassword: '***' });

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(service)
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Erro ao salvar serviço');
                }

                showToast('Serviço salvo com sucesso!', 'success');
                closeAddModal();
                await fetchServices(); // Recarrega a lista de serviços
        }

        async function renderCards(servicesData) {
            console.log('Renderizando cards com dados:', servicesData);
            cardsContainer.innerHTML = '';
            servicesData.forEach((service, index) => {
                console.log('Renderizando serviço:', service);
                const card = document.createElement('div');
                card.className = 'column is-one-third';
                
                // Garantir que a categoria tenha um valor padrão se não estiver definida
                const categoria = service.setor || 'Cliente';
                
                card.innerHTML = `
                    <div class="card ${service.inUse ? 'is-warning' : ''}" onclick="handleCardClick(event, ${index})">
                        <div class="card-content has-text-centered">
                            <span id="status-${service._id}" class="status-indicator ${service.status === 'active' ? 'status-active' : 'status-inactive'}"></span>
                            <div class="category-badge is-info">
                                <img src="/assets/neo-logo-small.png" alt="Neo" style="height: 20px;">
                            </div>
                            <span class="card-icon"><i class="fas fa-server"></i></span>
                            <p class="title is-4">${service.name}</p>
                            <p class="subtitle is-6">
                                IP: ${service.ip}
                            </p>
                            <p class="subtitle is-6">
                                Usuário Atual: ${service.currentUser || 'Nenhum'}
                            </p>
                            <div class="card-actions">
                                <button class="button is-small is-success" onclick="startService(${index})" title="Iniciar Serviço"
                                    id="start-btn-${service._id}">
                                    <span class="icon"><i class="fas fa-play"></i></span>
                                </button>
                                <button class="button is-small is-danger" onclick="stopService(${index})" title="Parar Serviço"
                                    id="stop-btn-${service._id}">
                                    <span class="icon"><i class="fas fa-stop"></i></span>
                                </button>
                                <button class="button is-small is-info" onclick="restartService(${index})" title="Reiniciar Serviço">
                                    <span class="icon"><i class="fas fa-sync"></i></span>
                                </button>
                                <button class="button is-small" onclick="viewLogs(${index})" title="Ver Logs">
                                    <span class="icon"><i class="fas fa-file-alt"></i></span>
                                </button>
                                <button class="button is-small is-warning" onclick="openMaintenanceModal(${index})" title="Manutenção">
                                    <span class="icon"><i class="fas fa-tools"></i></span>
                                </button>
                                <button class="button is-small is-danger" onclick="removeService(${index})" title="Excluir Serviço">
                                    <span class="icon"><i class="fas fa-trash"></i></span>
                                </button>
                                <button class="button is-small is-info" onclick="openDomainConfigModal(${index})" title="Configurar Domain">
                                    <span class="icon"><i class="fas fa-cog"></i></span>
                                </button>
                            </div>
                            <div class="user-buttons">
                                <button class="button is-small is-info" onclick="openUserNameModal(${index})" title="Marcar como em uso">
                                    <span class="icon"><i class="fas fa-user-check"></i></span>
                                </button>
                                <button class="button is-small is-success" onclick="markServiceAvailable(${index})" title="Marcar como disponível">
                                    <span class="icon"><i class="fas fa-user-times"></i></span>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                cardsContainer.appendChild(card);
            });

            emptyMessage.style.display = servicesData.length > 0 ? 'none' : 'block';
            resultsCount.textContent = `Exibindo ${servicesData.length} serviços`;
        }

        // Funções de manipulação de status
        async function startService(index) {
            const service = services[index];
            try {
                const response = await fetch(`/api/servicos/${service._id}/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Erro ao iniciar serviço');
                }

                const data = await response.json();
                showToast(data.message, 'success');
                await checkServiceStatus(service);
            } catch (error) {
                showToast(error.message, 'danger');
            }
        }

        async function stopService(index) {
            const service = services[index];
            try {
                const response = await fetch(`/api/servicos/${service._id}/stop`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Erro ao parar serviço');
                }

                const data = await response.json();
                showToast(data.message, 'success');
                await checkServiceStatus(service);
            } catch (error) {
                showToast(error.message, 'danger');
            }
        }

        // Atualizar a função restart
        async function restartService(index) {
            const service = services[index];
            
            // Obter referência aos botões
            const restartButton = document.querySelector(`button[onclick="restartService(${index})"]`);
            const startButton = document.getElementById(`start-btn-${service._id}`);
            const stopButton = document.getElementById(`stop-btn-${service._id}`);
            
            try {
                // Desabilitar todos os botões e mostrar loading
                restartButton.classList.add('is-loading');
                startButton.disabled = true;
                stopButton.disabled = true;
                restartButton.disabled = true;

                // Usar a rota de restart
                const response = await fetch(`/api/servicos/${service._id}/restart`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || 'Erro ao reiniciar serviço');
                }
                
                const data = await response.json();
                showToast('Serviço reiniciado com sucesso!', 'success');
                
                // Atualizar status após alguns segundos
                setTimeout(() => {
                    checkServiceStatus(service);
                }, 5000);
            } catch (error) {
                console.error('Erro ao reiniciar serviço:', error);
                showToast('Erro ao reiniciar serviço: ' + error.message, 'danger');
            } finally {
                // Reabilitar todos os botões e remover loading
                restartButton.classList.remove('is-loading');
                startButton.disabled = false;
                stopButton.disabled = false;
                restartButton.disabled = false;
            }
        }

        async function removeService(index) {
            const service = services[index];
            
            if (!confirm(`Tem certeza que deseja excluir o serviço "${service.name}"?`)) {
                return;
            }
            
                try {
                    const response = await fetch(`/api/servicos/${service._id}`, { 
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                    });
                    
                    if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.details || data.error || 'Erro ao excluir serviço');
                    }
                    
                services.splice(index, 1);
                renderCards(services);
                showToast(`Serviço "${service.name}" removido com sucesso`, 'success');
                } catch (error) {
                    console.error('Erro ao excluir serviço:', error);
                showToast(`Erro ao excluir serviço: ${error.message}`, 'danger');
            }
        }

        function filterCards() {
            const statusFilter = document.getElementById('filter-status').value;
            const filteredServices = statusFilter === 'all' ? services :
                services.filter(service => service.status === statusFilter);
            renderCards(filteredServices);
        }

        // Ordenação
        function sortCards(criteria) {
            const sortedServices = [...services].sort((a, b) => {
                if (criteria === 'name') {
                    return a.name.localeCompare(b.name);
                } else if (criteria === 'status') {
                    return a.status.localeCompare(b.status);
                } else if (criteria === 'setor') {
                    return a.setor.localeCompare(b.setor);
                }
                return 0;
            });
            renderCards(sortedServices);
        }

        function toggleLiveLog() {
            const statusElement = document.getElementById('live-log-status');
            
            if (currentWebSocket) {
                currentWebSocket.close();
                currentWebSocket = null;
                statusElement.textContent = 'Iniciar Live Log';
                return;
            }

            const service = services[currentServiceId];
            const ws = new WebSocket(`ws://${window.location.host}/api/servicos/${service._id}/logs/live`);
            
            ws.onmessage = (event) => {
                const logsContent = document.getElementById('logs-content');
                logsContent.textContent += event.data;
                logsContent.scrollTop = logsContent.scrollHeight;
            };

            ws.onclose = () => {
                statusElement.textContent = 'Iniciar Live Log';
                currentWebSocket = null;
            };

            currentWebSocket = ws;
            statusElement.textContent = 'Parar Live Log';
        }

        async function viewLogs(index) {
            currentServiceId = index;
            try {
                const service = services[index];
                const response = await fetch(`/api/servicos/${service._id}/logs`);
                const data = await response.json();
                if (data.error) {
                    alert(data.error);
                    return;
                }
                document.getElementById('logs-content').textContent = data.logs;
                document.getElementById('logs-modal').classList.add('is-active');
            } catch (error) {
                console.error('Erro ao obter logs:', error);
                alert('Erro ao obter logs');
            }
        }

        function closeLogsModal() {
            if (currentWebSocket) {
                currentWebSocket.close();
                currentWebSocket = null;
            }
            document.getElementById('logs-modal').classList.remove('is-active');
        }

        function toggleSSHPasswordVisibility() {
            const passwordInput = document.getElementById('service-ssh-password');
            const eyeIcon = document.getElementById('ssh-eye-icon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                eyeIcon.classList.remove('fa-eye');
                eyeIcon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                eyeIcon.classList.remove('fa-eye-slash');
                eyeIcon.classList.add('fa-eye');
            }
        }

        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('service-password');
            const eyeIcon = document.getElementById('eye-icon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                eyeIcon.classList.remove('fa-eye');
                eyeIcon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                eyeIcon.classList.remove('fa-eye-slash');
                eyeIcon.classList.add('fa-eye');
            }
        }

        async function testSSHConnection() {
            const ip = document.getElementById('service-ip').value;
            const username = document.getElementById('service-ssh-username').value;
            const password = document.getElementById('service-ssh-password').value;

            // Validar se todos os campos estão preenchidos
            if (!ip || !username || !password) {
                showToast('Por favor, preencha todos os campos SSH', 'warning');
                return;
            }

            try {
                const response = await fetch('/api/test-ssh', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ip: ip,
                        username: username,
                        password: password
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showToast('Conexão SSH testada com sucesso', 'success');
                } else {
                    showToast(data.error || 'Erro ao testar conexão SSH', 'danger');
                }
            } catch (error) {
                showToast('Erro ao testar conexão SSH: ' + error.message, 'danger');
            }
        }

        function showToast(message, type) {
            if (type === 'success' || type === 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast is-${type} show`;
            
            setTimeout(() => {
                    toast.className = toast.className.replace('show', '');
            }, 3000);
            }

            // Adicionar ao log para todos os tipos de mensagem
            addLogEntry(message, type);
        }

        function addLogEntry(message, type) {
            if (!logViewerActive) return; // Não adicionar logs se o visualizador estiver desativado

            const logViewer = document.getElementById('log-viewer');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${type.toUpperCase()}: ${message}`;
            logViewer.appendChild(logEntry);

            // Manter o scroll no final
            logViewer.scrollTop = logViewer.scrollHeight;
        }

        function openAdminPanel() {
            const ip = document.getElementById('service-ip').value;
            const port = document.getElementById('service-port').value;
            const url = `https://${ip}:${port}`;
            window.open(url, '_blank');
        }

        // Atualizar a função updateDashboardStats para refletir as sugestões
        async function updateDashboardStats() {
            try {
                const response = await fetch('/api/servicos/stats/overview');
                if (!response.ok) {
                    throw new Error('HTTP error! status: ' + response.status);
                }
                const overview = await response.json();

                // Atualizar contadores
                document.getElementById('total-servers').textContent = overview.totalServers;
                document.getElementById('active-servers').textContent = overview.activeServers;
                
                // Atualizar médias e barras de progresso
                document.getElementById('avg-ram-usage').textContent = `${overview.averageMemory}%`;
                document.getElementById('avg-cpu-usage').textContent = `${overview.averageCpu}%`;
                
                const ramProgress = document.getElementById('ram-progress');
                const cpuProgress = document.getElementById('cpu-progress');
                
                if (ramProgress && cpuProgress) {
                    ramProgress.value = overview.averageMemory || 0;
                    cpuProgress.value = overview.averageCpu || 0;
                updateProgressColor(ramProgress, overview.averageMemory);
                updateProgressColor(cpuProgress, overview.averageCpu);
                }

                // Atualizar detalhes dos servidores
                const detailsContainer = document.getElementById('server-details');
                if (detailsContainer) {
                    if (overview.serverDetails && Array.isArray(overview.serverDetails)) {
                        const detailsHtml = overview.serverDetails.map(server => `
                            <div class="box server-detail">
                                <div class="columns is-vcentered">
                                    <div class="column is-3">
                                        <strong>${server.name}</strong>
                                    </div>
                                    <div class="column is-2">
                                        <span class="tag ${server.status === 'active' ? 'is-success' : 'is-danger'}">
                                            ${server.status}
                                        </span>
                                    </div>
                                    <div class="column is-3">
                                        <div class="level is-mobile">
                                            <div class="level-item">
                                                <div>
                                                    <p class="heading">RAM</p>
                                                    <p class="title is-6">${server.memory}%</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="column is-3">
                                        <div class="level is-mobile">
                                            <div class="level-item">
                                                <div>
                                                    <p class="heading">CPU</p>
                                                    <p class="title is-6">${server.cpu}%</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                        detailsContainer.innerHTML = detailsHtml;
                    } else {
                        detailsContainer.innerHTML = `
                            <div class="notification is-info is-light">
                                <p>Nenhum detalhe disponível</p>
                            </div>
                        `;
                    }
                }

            } catch (error) {
                console.error('Erro ao atualizar estatísticas:', error);
                showToast('Erro ao atualizar estatísticas: ' + error.message, 'danger');
            }
        }

        // Função para atualizar cores das barras de progresso
        function updateProgressColor(progressBar, value) {
            progressBar.classList.remove('is-success', 'is-warning', 'is-danger');
            if (value < 60) {
                progressBar.classList.add('is-success');
            } else if (value < 80) {
                progressBar.classList.add('is-warning');
            } else {
                progressBar.classList.add('is-danger');
            }
        }

        // Iniciar monitoramento
        function startMonitoring() {
            // Primeira verificação imediata
            updateDashboardStats();
            checkAllServicesStatus();
            
            // Reduzir frequência das verificações
            const statsInterval = setInterval(updateDashboardStats, 60000);  // 1 minuto
            const statusInterval = setInterval(checkAllServicesStatus, 30000); // 30 segundos
            
            // Limpar intervalos quando a página for fechada
            window.addEventListener('beforeunload', () => {
                clearInterval(statsInterval);
                clearInterval(statusInterval);
            });
        }

        function handleAccessTypeChange() {
            const accessType = document.getElementById('service-access-type').value;
            const ipInput = document.getElementById('service-ip');
            const portInput = document.getElementById('service-port');
            
            if (accessType === 'external') {
                ipInput.placeholder = "IP externo ou hostname";
                // Você pode adicionar validações específicas para IPs externos
            } else {
                ipInput.placeholder = "IP local (192.168.x.x)";
            }
        }

        function openMaintenanceModal(index) {
            event.stopPropagation(); // Evita que o modal de edição abra
            currentMaintenanceIndex = index;
            const service = services[index];
            if (!service) {
                showToast('Serviço não encontrado', 'danger');
                return;
            }
            // Armazenar o ID do serviço no botão de execução
            const executeButton = document.querySelector('#maintenance-modal .button.is-danger');
            executeButton.setAttribute('data-service-id', service._id);
            // Limpa os checkboxes
            document.getElementById('clean-applications').checked = false;
            document.getElementById('clean-logs').checked = false;
            document.getElementById('clean-generated').checked = false;
            document.getElementById('clean-autodeploy').checked = false;
            // Abre o modal
            document.getElementById('maintenance-modal').classList.add('is-active');
        }

        function closeMaintenanceModal() {
            document.getElementById('maintenance-modal').classList.remove('is-active');
            currentMaintenanceIndex = null;
        }

        async function executeMaintenanceFromModal(button) {
            const serviceId = button.getAttribute('data-service-id');
            if (!serviceId) {
                showToast('ID do serviço não encontrado', 'danger');
                return;
            }

            // Coletar todas as tarefas selecionadas
            const tasks = [];
            if (document.getElementById('clean-applications').checked) {
                tasks.push('cleanApplications');
            }
            if (document.getElementById('clean-logs').checked) {
                tasks.push('cleanLogs');
            }
            if (document.getElementById('clean-generated').checked) {
                tasks.push('cleanGenerated');
            }
            if (document.getElementById('clean-autodeploy').checked) {
                tasks.push('cleanAutodeploy');
            }

            // Verificar se pelo menos uma tarefa foi selecionada
            if (tasks.length === 0) {
                showToast('Selecione pelo menos uma opção de limpeza', 'warning');
                return;
            }

            // Adicionar loading state
            button.classList.add('is-loading');
            button.disabled = true;
            
            try {
                await executeMaintenanceTasks(serviceId, tasks);
                closeMaintenanceModal();
            } catch (error) {
                showToast(error.message, 'danger');
            } finally {
                button.classList.remove('is-loading');
                button.disabled = false;
            }
        }

        async function executeMaintenanceTasks(serviceId, tasks) {
            try {
                // Primeiro, obter o serviço
                const service = services.find(s => s._id === serviceId);
                if (!service) {
                    throw new Error('Serviço não encontrado');
                }

                // Executar a manutenção
                const response = await fetch(`/api/servicos/${serviceId}/maintenance`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tasks })
                });

                if (!response.ok) {
                    throw new Error(`Erro HTTP! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Resposta da manutenção:', data);
                
                // Mostrar resultados detalhados
                let message = 'Tarefas executadas:\n';
                data.results.forEach(result => {
                    message += `\n${result.task}: ${result.success ? '✓' : '✗'} ${result.message}`;
                });
                showToast(message, 'success');
                
                // Atualizar o status do serviço
                await fetchServices();
                
            } catch (error) {
                console.error('Erro na manutenção:', error);
                showToast('Erro ao executar a manutenção: ' + error.message, 'danger');
            }
        }

        function openDomainConfigModal(index) {
            event.stopPropagation();
            currentDomainConfigIndex = index;
            const service = services[index];
            
            // Limpar campos e mostrar loading
            setLoadingState(true);
            
            // Resetar campos
            document.getElementById('db-server').value = '';
            document.getElementById('db-user').value = '';
            document.getElementById('db-password').value = '';
            document.getElementById('db-name').value = '';
            
            // Resetar aplicações
            const loadingEl = document.getElementById('applications-loading');
            const contentEl = document.getElementById('applications-content');
            contentEl.innerHTML = '';
            loadingEl.classList.remove('is-hidden');
            contentEl.classList.add('is-hidden');
            
            // Abrir modal
            document.getElementById('domain-config-modal').classList.add('is-active');
            
            // Carregar configurações
            loadDomainConfig(service);
            loadApplicationsList(service);
        }

        function closeDomainConfigModal() {
            document.getElementById('domain-config-modal').classList.remove('is-active');
            currentDomainConfigIndex = null;
        }

        async function loadDomainConfig(service) {
            setLoadingState(true);
            
            try {
                const response = await fetch(`/api/servicos/${service._id}/domain-config`);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Erro ao carregar configurações');
                }
                
                // Atualizar os campos com os valores
                document.getElementById('db-server').value = data.serverName || '';
                document.getElementById('db-user').value = data.user || '';
                document.getElementById('db-password').value = data.password || '';
                document.getElementById('db-name').value = data.databaseName || '';
                
            } catch (error) {
                console.error('Erro ao carregar configurações:', error);
                showToast(`Erro ao carregar configurações: ${error.message}`, 'danger');
            } finally {
                setLoadingState(false);
            }
        }

        function setLoadingState(isLoading) {
            const fields = ['server', 'user', 'password', 'name'];
            fields.forEach(field => {
                const input = document.getElementById(`db-${field}`);
                const loadingIcon = document.getElementById(`db-${field}-loading`);
                
                input.disabled = isLoading;
                input.placeholder = isLoading ? 'Carregando...' : '';
                
                if (loadingIcon) {
                    loadingIcon.style.display = isLoading ? 'block' : 'none';
                }
            });
        }

        function getDefaultPlaceholder(field) {
            switch (field) {
                case 'server': return '192.168.1.103';
                case 'user': return 'postgres';
                case 'name': return 'neocorp';
                default: return '';
            }
        }

        function updateDatabaseFields(config) {
            document.getElementById('db-server').value = config.serverName || '';
            document.getElementById('db-user').value = config.user || '';
            document.getElementById('db-password').value = config.password || '';
            document.getElementById('db-name').value = config.databaseName || '';
        }

        async function loadApplicationsList(service) {
            const loadingEl = document.getElementById('applications-loading');
            const contentEl = document.getElementById('applications-content');
            
            try {
            loadingEl.classList.remove('is-hidden');
            contentEl.classList.add('is-hidden');

                const response = await fetch(`/api/servicos/${service._id}/applications`);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.details || data.error || 'Erro ao listar aplicações');
                }
                
                let content = '';
                if (data.error) {
                    content = `
                        <div class="notification is-warning">
                            <p>${data.message || 'Erro ao carregar aplicações'}</p>
                        </div>
                    `;
                } else if (!data.applications || data.applications.length === 0) {
                    content = `
                        <div class="notification is-info">
                            <p>Nenhuma aplicação instalada</p>
                        </div>
                    `;
                } else {
                    content = data.applications.map(app => `
                            <div class="box">
                                <strong>${app.name}</strong>
                            <p class="help">Status: ${app.status}</p>
                            <p class="help">Engine: ${app.engine}</p>
                                <p class="help">Localização: ${app.location}</p>
                            </div>
                    `).join('');
                }
                
                contentEl.innerHTML = content;
            } catch (error) {
                console.error('Erro ao carregar aplicações:', error);
                contentEl.innerHTML = `
                    <div class="notification is-danger">
                        <p>Erro ao carregar aplicações: ${error.message}</p>
                    </div>
                `;
            } finally {
                loadingEl.classList.add('is-hidden');
                contentEl.classList.remove('is-hidden');
            }
        }

        async function saveDomainConfig() {
            try {
            const service = services[currentDomainConfigIndex];
                if (!service) {
                    throw new Error('Serviço não encontrado');
                }

                // Coletar os valores dos campos
            const config = {
                    serverName: document.getElementById('db-server').value.trim(),
                    user: document.getElementById('db-user').value.trim(),
                    password: document.getElementById('db-password').value.trim(),
                    databaseName: document.getElementById('db-name').value.trim()
                };

                // Validar se todos os campos estão preenchidos
                if (!config.serverName || !config.user || !config.password || !config.databaseName) {
                    showToast('Por favor, preencha todos os campos', 'warning');
                    return;
                }

                // Adicionar loading state
                const saveButton = document.querySelector('#domain-config-modal .button.is-success');
                saveButton.classList.add('is-loading');
                saveButton.disabled = true;

            try {
                const response = await fetch(`/api/servicos/${service._id}/domain-config`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || errorData.details || 'Erro ao salvar configurações');
                }

                    const data = await response.json();
                showToast('Configurações salvas com sucesso!', 'success');
                closeDomainConfigModal();
            } catch (error) {
                console.error('Erro ao salvar configurações:', error);
                    showToast(error.message, 'danger');
                    throw error;
                } finally {
                    // Remover loading state
                    saveButton.classList.remove('is-loading');
                    saveButton.disabled = false;
                }
            } catch (error) {
                console.error('Erro ao salvar configurações:', error);
                showToast(error.message, 'danger');
            }
        }

        function switchTab(tab) {
            const tabs = document.querySelectorAll('.tabs li');
            const contents = document.querySelectorAll('.tab-content');
            
            // Remover classe ativa de todas as tabs
            tabs.forEach(t => t.classList.remove('is-active'));
            
            // Esconder todos os conteúdos
            contents.forEach(c => {
                c.style.display = 'none';
                // Garantir que o conteúdo está oculto usando classes também
                c.classList.remove('is-active');
            });
            
            // Ativar a tab selecionada
            const activeTab = document.querySelector(`.tabs li a[onclick="switchTab('${tab}')"]`).parentElement;
            activeTab.classList.add('is-active');
            
            // Mostrar o conteúdo da tab selecionada
            const activeContent = document.getElementById(`${tab}-tab`);
            activeContent.style.display = 'block';
            activeContent.classList.add('is-active');
        }

        document.getElementById('application-file').addEventListener('change', function(e) {
            const fileName = e.target.files[0]?.name || 'Nenhum arquivo selecionado';
            document.getElementById('file-name').textContent = fileName;
            document.getElementById('upload-button').disabled = !e.target.files[0];
        });

        async function uploadApplication() {
            const fileInput = document.getElementById('application-file');
            const uploadButton = document.getElementById('upload-button');
            const file = fileInput.files[0];
            if (!file) {
                showToast('Selecione um arquivo para upload', 'warning');
                return;
            }

            const service = services[currentDomainConfigIndex];
            const formData = new FormData();
            formData.append('file', file);

            try {
                uploadButton.classList.add('is-loading');
                uploadButton.disabled = true;
                
                // Corrigir a URL para usar o ID correto do serviço
                const response = await fetch(`/api/servicos/${service._id}/upload-application`, {
                    method: 'POST',
                    body: formData
                });

                // Verificar se a resposta não é OK antes de tentar parsear JSON
                if (!response.ok) {
                    const contentType = response.headers.get('content-type');
                    let errorMessage;
                    
                    if (contentType && contentType.includes('application/json')) {
                        const errorData = await response.json();
                        errorMessage = errorData.error || 'Erro ao fazer upload da aplicação';
                    } else {
                        errorMessage = `Erro ${response.status}: ${response.statusText}`;
                    }
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                showToast('Upload realizado com sucesso!', 'success');
                fileInput.value = '';
                document.getElementById('file-name').textContent = 'Nenhum arquivo selecionado';
                uploadButton.disabled = true;
                
                // Recarregar lista de aplicações
                await loadApplicationsList(service);
            } catch (error) {
                console.error('Erro no upload:', error);
                let errorMessage = error.message;
                if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'Erro de conexão. Verifique o tamanho do arquivo e tente novamente.';
                }
                showToast('Erro ao fazer upload: ' + errorMessage, 'danger');
            } finally {
                uploadButton.classList.remove('is-loading');
                uploadButton.disabled = false;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchServices();
            startMonitoring();

            const copyLogButton = document.getElementById('copy-log-button');
            const logContent = document.getElementById('logs-content');

            copyLogButton.addEventListener('click', () => {
                const range = document.createRange();
                range.selectNode(logContent);
                window.getSelection().removeAllRanges(); // Limpar seleções anteriores
                window.getSelection().addRange(range);

                try {
                    const successful = document.execCommand('copy');
                    const msg = successful ? 'Logs copiados com sucesso!' : 'Falha ao copiar logs';
                    showToast(msg, successful ? 'success' : 'danger');
                } catch (err) {
                    showToast('Erro ao copiar logs', 'danger');
                }

                window.getSelection().removeAllRanges(); // Limpar seleção após copiar
            });
        });

        async function checkServiceStatus(service) {
            try {
                const response = await fetch(`/api/servicos/${service._id}/status`);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.details || data.error || 'Erro ao verificar status');
                }

                // Se houver erro de instalação, mostrar mensagem específica
                if (data.status === 'error' && data.details?.error === 'installation_not_found') {
                    showToast(`Erro no servidor ${service.name}: ${data.details.message}`, 'warning');
                    return data;
                }

                const statusIndicator = document.querySelector(`#status-${service._id}`);
                if (statusIndicator) {
                    statusIndicator.className = `status-indicator ${data.status === 'active' ? 'status-active' : 'status-inactive'}`;
                    service.status = data.status;
                    service.pid = data.pid;
                }

                return data;
            } catch (error) {
                console.error(`Erro ao verificar status de ${service.name}:`, error);
                return { 
                    status: 'error', 
                    pid: null,
                    error: error.message
                };
            }
        }

        async function markServiceInUse(index, userName) {
            const service = services[index];
            try {
                const response = await fetch(`/api/servicos/${service._id}/in-use`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user: userName })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Erro ao marcar serviço como em uso');
                }

                const data = await response.json();
                showToast(`${data.message} por ${data.currentUser}`, 'success');
                service.inUse = true;
                service.currentUser = data.currentUser;
                renderCards(services);
            } catch (error) {
                showToast(error.message, 'danger');
            }
        }

        async function markServiceAvailable(index) {
            const service = services[index];
            try {
                const response = await fetch(`/api/servicos/${service._id}/available`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Erro ao marcar serviço como disponível');
                }

                const data = await response.json();
                showToast(data.message, 'success');
                service.inUse = false;
                service.currentUser = '';
                renderCards(services);
            } catch (error) {
                showToast(error.message, 'danger');
            }
        }

        function openUserNameModal(index) {
            const modal = document.getElementById('user-name-modal');
            modal.classList.add('is-active');

            // Tentar buscar o nome do usuário do localStorage
            const storedUserName = localStorage.getItem('userName');
            if (storedUserName) {
                document.getElementById('modal-user-name').value = storedUserName;
            }

            // Armazenar o índice do serviço atual para uso posterior
            modal.dataset.serviceIndex = index;
        }

        function closeUserNameModal() {
            const modal = document.getElementById('user-name-modal');
            modal.classList.remove('is-active');
        }

        function confirmUserName() {
            const modal = document.getElementById('user-name-modal');
            const userName = document.getElementById('modal-user-name').value.trim();

            if (userName) {
                // Salvar o nome do usuário no localStorage
                localStorage.setItem('userName', userName);

                // Obter o índice do serviço e marcar como em uso
                const serviceIndex = modal.dataset.serviceIndex;
                markServiceInUse(serviceIndex, userName);

                closeUserNameModal();
                    } else {
                showToast('Por favor, insira seu nome', 'warning');
            }
        }

        function handleCardClick(event, index) {
            // Verificar se o clique foi em um botão
            if (event.target.closest('button')) {
                return; // Não fazer nada se o clique foi em um botão
            }
            openAddModal(index); // Abrir o modal se o clique não foi em um botão
        }

        function toggleLogViewer() {
            logViewerActive = !logViewerActive;
            const logViewer = document.getElementById('log-viewer');
            logViewer.style.display = logViewerActive ? 'block' : 'none';
        }

        function clearLogViewer() {
            const logViewer = document.getElementById('log-viewer');
            logViewer.innerHTML = '';
        }

        function accessNeoWeb() {
            const ip = document.getElementById('service-ip').value.trim();
            const productionPort = document.getElementById('production-port').value.trim();

            if (!ip || !productionPort) {
                showToast('Por favor, preencha o IP e a Porta de Produção', 'warning');
                return;
            }

            const url = `https://${ip}:${productionPort}/neocorp`;
            window.open(url, '_blank');
        }
    </script>
    <script src="js/theme-manager.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Carregar e aplicar tema salvo
            const userSettings = JSON.parse(localStorage.getItem('userSettings')) || {};
            if (userSettings.theme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
                document.body.classList.add('dark-theme');
            }
        });
    </script>
</body>
</html>